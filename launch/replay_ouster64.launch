<launch>
<!-- Launch file for ouster OS2-64 LiDAR-->

    <arg name="mav_name" default="kolibri"/>
    <arg name="rviz" default="false" />
    <arg name="node_start_delay" default="10.0" />
    <arg name="record_bag" default="true" />
    <arg name="target_bag" default="test" />

      <!-- Rosbag replay:
            2022-09-06-17-21-21_slight_drift_allmend.bag
            2022-09-06-17-21-21_slight_drift_allmend_corrupted.bag
            2022-06-16-18-18-56_slight_drift.bag -->

    <arg name="bag_name" value="/home/lucas/bags/gtsam_fusion/2022-09-06-17-21-21_slight_drift_allmend_corrupted.bag" />
    <!---->
    <group ns="$(arg mav_name)">

      <node pkg="rosbag" type="play" required="true"
            name="replay" args="
              $(arg bag_name) 
              /alphasense_driver_ros/imu:=/kolibri/alphasense_driver_ros/imu
              /os_cloud_node/points:=/kolibri/os_cloud_node/points
              --clock
              ">
        <param name="capability_group" value="10 LIO replay"/>
      </node>
      
      
      <!-- recorder -->
      <node pkg="rosbag" type="record"
            name="record"  args="
              -O $(env HOME)/bags/gtsam_fusion/$(arg target_bag) 
              /Odometry 
              /kolibri/transform_flu 
              /kolibri/mavros/local_position/pose 
              /kolibri/mav_state_estimator/optimization 
              /debug/odom
              ">
      </node>
      
      <!-- applied params from kolibri_subt_hw -->
      <rosparam file="$(find fast_lio)/config/ouster_os0.yaml" command="load"/>

      <param name="feature_extract_enable" type="bool" value="0"/>
      <param name="point_filter_num" type="int" value="2"/>
      <param name="max_iteration" type="int" value="5" />
      <param name="filter_size_surf" type="double" value="0.45" />
      <param name="filter_size_map" type="double" value="0.45" />
      <param name="cube_side_length" type="double" value="200" />
      <param name="runtime_pos_log_enable" type="bool" value="0" />
      <node pkg="fast_lio" type="fastlio_mapping" name="laserMapping" output="screen"  launch-prefix="bash -c 'sleep $(arg node_start_delay); $0 $@' "/>

      <!-- IMU FLU Rotater -->
      <node pkg="mav_startup" type="kolibri_flip_imu.py" name="imu_flu_publisher" output="screen" required="true">
        <remap from="~imu_in" to="/$(arg mav_name)/alphasense_driver_ros/imu" />
        <remap from="~imu_out" to="/$(arg mav_name)/alphasense_driver_ros/imu_flu" />
        <param name="capability_group" value="03 Sensors" />
      </node>

      <!-- static transforms -->
      <node pkg="tf" type="static_transform_publisher" respawn="true"
						name="tfs_world2caminit" args="0 0 0 0 0 0 1 /world /camera_init 100">
				<param name="capability_group" value="04 Static Transforms"/>
			</node>

			<node pkg="tf" type="static_transform_publisher" respawn="true"
						name="tfs_caminit2odom" args="0 0 0 0 0 0 /camera_init /odom 100 ">
				<param name="capability_group" value="04 Static Transforms"/>
			</node>

			<node pkg="tf" type="static_transform_publisher"
						name="tfs_msf2px4_loam" args="0 0 0 0 0 0 /$(arg mav_name)/msf_fixed /$(arg mav_name)/px4_fixed 1">
				<param name="capability_group" value="04 Static Transforms"/>
			</node>

    </group>

    <group if="$(arg rviz)">
      <node launch-prefix="bash -c 'sleep $(arg node_start_delay); $0 $@' nice" pkg="rviz" type="rviz" name="rviz" args="-d $(find fast_lio)/rviz_cfg/loam_livox.rviz" />
    </group>



</launch>
